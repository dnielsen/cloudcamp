<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
        <title></title>
        <link rel="shortcut icon" href="http://cloudcamp.org/bundles/cloudcamp/css/images/favicon.ico" />
        <link type="text/css" rel="stylesheet" href="css/cloudcamp.css" />
                
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <script type="text/javascript" src="js/utility.js"></script>
        <script type="text/javascript" src="js/config.js"></script>
        <script type="text/javascript" src="js/underscore-min.js"></script>

        <script id="addJS">

            var getGroupInfo = function () {
                return UTIL.campsite('groups/'+CONFIG.community, { 'fields': "name,description,groupAvatar.filename" });
            };

            var renderGroupInfo = function(group_info) {
                $('.group-title').html(group_info.name);
                if(_.has(group_info,"groupAvatar") && _.has(group_info.groupAvatar,"uri")) {
                    $("#logo-img").attr("src", group_info.groupAvatar.uri);
                }
            };

            var getGroupId = function (slug) {
                var dfd = $.Deferred();

                UTIL.campsite('groups', { 'parentGroup_id': CONFIG.community, 'fields': "id,relativeSlug" })
                .then( function(groupSlugs) {
                    // Find and save the id of the matching slug if there is one
                    var matchingGroup = _.find(groupSlugs, function(groupEntry) {
                        return groupEntry.relativeSlug === slug;
                    });

                    if( !matchingGroup ) {
                        dfd.reject();
                    } else {
                        GROUP_ID = matchingGroup.id;
                        dfd.resolve(); //return the group id
                    }
                })
                .fail( function() {  dfd.reject(); });

                return dfd.promise();
            };

            var getClosestEvent = function (groupEvents) {
                if( groupEvents.length === 0)
                    return null;

                var the_event;
                var is_upcoming = true;
                
                var now = Date.now();
                var upcoming = [];
                var past = [];
                _.each(groupEvents, function(event) {
                    var starts_at = new Date(event.starts_at);
                    var ends_at = new Date(event.ends_at);
                    if( starts_at.getTime() > now)
                        upcoming.unshift(event);
                    else if(ends_at.getTime() < now)
                        past.push(event);
                });

                if(upcoming.length > 0) {
                    the_event = upcoming[0];
                } else if(past.length > 0) {
                    the_event = past[0];
                    is_upcoming = false;
                }

                return { "e": the_event, "is_upcoming": is_upcoming };
            };

            var getEvent = function () {                
                var dfd = $.Deferred();
                UTIL.campsite('events', { 
                    'sort_by': "starts_at", 
                    'private': 0, 
                    'group_id': GROUP_ID, 
                    'fields': "id,starts_at,ends_at,name,content,external_url,parent_group.slug" 
                }).then( function (groupEvents) {
                    var evt = getClosestEvent(groupEvents);
                    evt ? dfd.resolve(evt) : dfd.reject();
                });

                return dfd.promise();
            };            

            var getSponsorships = function (filter_field, filter_value) {
                var queryParameters = { 'fields': 'level,sponsor', 'status': 'sponsoring' };
                queryParameters[filter_field] = filter_value;
                return UTIL.campsite('sponsorships', queryParameters);
            };

            var renderSponsorships = function(sponsorships) {
                var sponsorTemplate = '<li><a href="{link}"><img src="{image_url}" alt="{sponsor_name}"/></a></li>';
                var sponsorDiv = $('.sponsors-sidebar');
                var sponsorsHtml = '';

                _.each(sponsorships, function(sponsorship) {
                    var sponsor_html = sponsorTemplate.replace(/{link}/, sponsorship.sponsor.url);
                    sponsor_html = sponsor_html.replace(/{image_url}/, sponsorship.sponsor.image_uri);
                    sponsor_html = sponsor_html.replace(/{sponsor_name}/, sponsorship.sponsor.name);
                    sponsorsHtml += sponsor_html;
                });
                sponsorDiv.append(sponsorsHtml);
            };

            var handleGroup = function() {
                var group_uri = CONFIG.baseHost + "/groups/"+GROUP_ID+"?fields=description,name,groupAvatar.filename";
                $.getJSON(group_uri, function(group_data) {
                    document.title = group_data.name;
                    $('#register-button').remove();
                    $("#event-title").html(group_data.name);
                    $("#content").html( decodeURIComponent(group_data.description) );
                    if(_.has(group_data,"groupAvatar") && _.has(group_data.groupAvatar,"uri")) {
                        $("#logo-img").attr("src", group_data.groupAvatar.uri);
                    }
                });

                getSponsorships('group_id',GROUP_ID).then(renderSponsorships);
            };

            var handleEvent = function(event_data) {
                var evt = event_data.e;

                getSponsorships('event_id',evt.id).then(renderSponsorships);

                document.title = evt.name;
                var starts_at = new Date(evt.starts_at);
                var date_str = "(" + UTIL.getDate(starts_at) + ")";
                $("#event-title").html(evt.name + " " + date_str );
                $("#content").html( (evt.content) );
                $("a[href='event_speakers.html']").attr('href', 'event_speakers.html?id='+evt.id);

                var regBtn = $('#register-button');
                if(!event_data.is_upcoming) {
                    regBtn.remove();
                } else {
                    regBtn.attr('target', '_blank');
                    if (evt.external_url !== null) {
                        regBtn.attr('href', evt.external_url);
                    } else {
                        regBtn.attr('href', 'http://www.campsite.org/'+evt.parent_group.slug+'/event/'+evt.id);
                    }
                }
            };

            var SLUG = UTIL.getParameterByName('slug');
            var GROUP_ID;
            
            var dom_dfd = $(document).ready().promise(); // resolved on page load
            
            window.history.replaceState(null, '', SLUG);

            // Retrieve group details then wait for page to load (if necessary) and render the group data
            getGroupInfo()
            .then(dom_dfd)
            .then(renderGroupInfo);

            //Find subgroup of this community matching provided slug
            getGroupId(SLUG)
            
            // If the group was found, locate the closest event within that group
            .done( function(gid) {
                getEvent(gid)
                // Wait till DOM finishes loading
                .then(dom_dfd)
                // Render the details of the nearist event 
                // or render group if no events exist yet
                .then(handleEvent, handleGroup); 
            })
            // If no group found matching provided slug
            .fail(function() {
                $(".content").append('<p>The group ' + SLUG + ' does not exist on this site.</p>');
            });
            
        </script>
    </head>

    <body>
        <div id="wrap">
            <div class="shell">
                <div id="header">
                    <a href="index.html"><img id="logo-img"src=""></a>
                </div>
                <div id="nav">
                    <ul class="left">
                        <li class="left"><a href="index.html" class="">Home</a></li>
                        <li class="left"><a href="schedule.html" class="">Schedule</a></li>
                        <li class="left"><a href="event_speakers.html" class="">Speakers</a></li>
                        <li class="left reg"><a href="http://campsite.org/account/register">Register</a></li>
                        <li class="left reg"><a href="http://campsite.org/login">Sign in</a></li>
                    </ul>
                    <ul class="right">&nbsp;</ul>
                    <div class="cl">&nbsp;</div>
                </div>
                <div id="main">
                    <div class="content left">
                        <h1 id='event-title'></h1>
                        <div class="widget-content">
                            <p><a id="register-button" href="#" class="btn">Register for event</a></p>
                        </div>
                        <div>
                            <div id="content"><!-- event details here --></div>
                            <p>&nbsp;</p>
                        </div>
                    </div>
                    <div class="sidebar right">
                        <div class="section">
                            <h5>Sponsors</h5>
                            <ul class="sponsors-sidebar">
                            </ul>
                        </div>
                    </div>
                    <div class="cl"></div>
                        <div id="footer">
                            <div class="foot-nav left">
                                Â© 2012-2014 <span class="group-title"></span>.  All rights reserved.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </body>
</html>
