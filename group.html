<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
        <title></title>
        <link rel="shortcut icon" href="http://cloudcamp.org/bundles/cloudcamp/css/images/favicon.ico" />
        <link type="text/css" rel="stylesheet" href="css/cloudcamp.css" />
                
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <script type="text/javascript" src="js/utility.js"></script>
        <script type="text/javascript" src="js/underscore-min.js"></script>

        <script id="addJS">

            var slug = getParameterByName('slug');
            window.history.replaceState(null, '', slug);
            
            $.getJSON('properties.json', function(properties) {
                var community_id = properties.community_id;
                var baseHost     = 'http://api.campsite.org';
                var communityURI = baseHost + '/groups/'+community_id+'?fields=name,groupAvatar.filename';

                $.getJSON(communityURI, function(data) {
                    $('.group-title').html(data.name);
                    if(_.has(data,"groupAvatar") && _.has(data.groupAvatar,"uri")) {
                        $("#logo-img").attr("src", data.groupAvatar.uri);
                    }
                });

                var mappings = properties.slugs;
                if(!_.has(mappings, slug)) {
                    $(".content").append('<p>The group ' + slug + ' does not exist on this site.</p>');
                    return;
                } 

                var gid = mappings[slug];
                var fields            = 'fields=id,starts_at,ends_at,name,content,external_url,parent_group.slug&';
                var event_data_uri    = baseHost + '/events?'+fields+'sort_by=starts_at&private=0&group_id='+gid;
                var group_sponsorsURI = baseHost + '/sponsorships?status=sponsoring&group_id='+gid;
                var event_sponsorsURI = baseHost + '/sponsorships?status=sponsoring&event_id={eid}';

                $.getJSON(event_data_uri, function(groupEvents) {
                    var the_event;
                    var is_upcoming = true;
                    
                    var now = Date.now();
                    var upcoming = [];
                    var past = [];
                    _.each(groupEvents, function(event) {
                        var starts_at = new Date(event.starts_at);
                        var ends_at = new Date(event.ends_at);
                        if( starts_at.getTime() > now)
                            upcoming.unshift(event);
                        else if(ends_at.getTime() < now)
                            past.push(event);
                    });

                    if(upcoming.length > 0) {
                        the_event = upcoming[0];
                    } else if(past.length > 0) {
                        the_event = past[0];
                        is_upcoming = false;
                    }

                    var regBtn = $('#register-button');
                    if(_.isUndefined(the_event)) {
                        var group_uri = "http://api.campsite.org/groups/"+gid+"?fields=description,name,groupAvatar.filename";
                        $.getJSON(group_uri, function(group_data) {
                            document.title = group_data.name;
                            regBtn.remove();
                            $("#event-title").html(group_data.name);
                            $("#content").html( decodeURIComponent(group_data.description) );
                            if(_.has(group_data,"groupAvatar") && _.has(group_data.groupAvatar,"uri")) {
                                $("#logo-img").attr("src", group_data.groupAvatar.uri);
                            }
                        });

                        $.getJSON(group_sponsorsURI, function(data) {

                            var sponsorTemplate = '<li><a href="{link}"><img src="{image_url}" alt="{sponsor_name}"/></a></li>';
                            var sponsorDiv = $('.sponsors-sidebar');
                            var sponsorsHtml = '';

                            _.each(data, function(sponsorship) {
                                var sponsor_html = sponsorTemplate.replace(/{link}/, sponsorship.sponsor.url);
                                sponsor_html = sponsor_html.replace(/{image_url}/, sponsorship.sponsor.image_uri);
                                sponsor_html = sponsor_html.replace(/{sponsor_name}/, sponsorship.sponsor.name);
                                sponsorsHtml += sponsor_html;
                            });
                            sponsorDiv.append(sponsorsHtml);

                        });

                    } else {
                        document.title = the_event.name;
                        if(!is_upcoming) {
                            regBtn.remove();
                        } else {
                            regBtn.attr('target', '_blank');
                            if (the_event.external_url !== null) {
                                regBtn.attr('href', the_event.external_url);
                            } else {
                                regBtn.attr('href', 
                                    'http://www.campsite.org/'+the_event.parent_group.slug+'/event/'+the_event.id);
                            }
                        }
                        
                        var starts_at = new Date(the_event.starts_at);
                        var date_str = "(" + getDate(starts_at) + ")";
                        $("#event-title").html(the_event.name + " " + date_str );
                        $("#content").html( decodeURIComponent(the_event.content) );


                        $.getJSON(event_sponsorsURI.replace(/{eid}/, the_event.id), function(data) {

                            var sponsorTemplate = '<li><a href="{link}"><img src="{image_url}" alt="{sponsor_name}"/></a></li>';
                            var sponsorDiv = $('.sponsors-sidebar');
                            var sponsorsHtml = '';

                            _.each(data, function(sponsorship) {
                                var sponsor_html = sponsorTemplate.replace(/{link}/, sponsorship.sponsor.url);
                                sponsor_html = sponsor_html.replace(/{image_url}/, sponsorship.sponsor.image_uri);
                                sponsor_html = sponsor_html.replace(/{sponsor_name}/, sponsorship.sponsor.name);
                                sponsorsHtml += sponsor_html;
                            });
                            sponsorDiv.append(sponsorsHtml);
                            
                        });
                    }
                });
            });
        </script>
    </head>

    <body>
        <div id="wrap">
            <div class="shell">
                <div id="header">
                    <a href="/index.html"><img id="logo-img"src=""></a>
                </div>
                <div id="nav">
                    <ul class="left">
                        <li class="left"><a href="/index.html" class="">Home</a></li>
                        <li class="left"><a href="/schedule.html" class="">Schedule</a></li>
                        <li class="left reg"><a href="http://campsite.org/account/register">Register</a></li>
                        <li class="left reg"><a href="http://campsite.org/login">Sign in</a></li>
                    </ul>
                    <ul class="right">&nbsp;</ul>
                    <div class="cl">&nbsp;</div>
                </div>
                <div id="main">
                    <div class="content left">
                        <h1 id='event-title'></h1>
                        <div class="widget-content">
                            <p><a id="register-button" href="#" class="btn">Register for event</a></p>
                        </div>
                        <div>
                            <div id="content"><!-- event details here --></div>
                            <p>&nbsp;</p>
                        </div>
                    </div>
                    <div class="sidebar right">
                        <div class="section">
                            <h5>Sponsors</h5>
                            <ul class="sponsors-sidebar">
                            </ul>
                        </div>
                    </div>
                    <div class="cl"></div>
                        <div id="footer">
                            <div class="foot-nav left">
                                Â© 2012-2014 <span class="group-title"></span>.  All rights reserved.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </body>
</html>
