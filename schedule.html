<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
        <title></title>
        <link rel="shortcut icon" href="http://cloudcamp.org/bundles/cloudcamp/css/images/favicon.ico" />
        <link type="text/css" rel="stylesheet" href="css/cloudcamp.css" />
                
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <script type="text/javascript" src="js/utility.js"></script>
        <script type="text/javascript" src="js/underscore-min.js"></script>
        
        <script id="addJS">

            $.getJSON('properties.json', function(properties) {
                var community_id = properties.community_id;

                jQuery(document).ready(function($) {

                    var baseHost     = 'http://api.campsite.org';
                    var communityURI = baseHost + '/groups/'+community_id+'?fields=name,groupAvatar.filename';
                    var eventsURI    = baseHost + '/groups/'+community_id+'/events';
                    
                    var template = "<tr class=\"eventListGroup_online\"><td>{date}</td><td><a href=\"{link}\">{name}</a></td><td>{location}</td></tr>";
        
                    var now = new Date();
                    $.getJSON(communityURI, function(data) {
                        document.title = data.name;
                        $('.group-title').html(data.name);
                        if(_.has(data,"groupAvatar") && _.has(data.groupAvatar,"uri")) {
                            $("#logo-img").attr("src", data.groupAvatar.uri);
                        }
                    });
                    $.getJSON(eventsURI, function(data) {
                        var future = $("#upcoming");
                        var past = $("#recent");
                        var event_ids = '';
                        var first_iteration = true;

                        _.each(data, function (event) {

                            event_ids = event.id + (first_iteration ? '' : ',') + event_ids;
                            first_iteration = false;

                            var starts_at = new Date(event.starts_at);
                            var ends_at = new Date(event.ends_at);

                            if(ends_at.getTime() >= now.getTime()) {
                                future.prepend(render_template(event,template));
                            } else if(starts_at.getTime() < now.getTime()) {
                                past.append(render_template(event,template));
                            }
                        });

                        var events_sponsors_uri = baseHost + '/sponsorships?event_id='+event_ids+'&fields=level,sponsor';
                        $.getJSON(events_sponsors_uri, function(data) {
                            var sponsorsHtml = '';
                            _.each(data, function(sponsorship) {
                                sponsorsHtml += '<li><a href="'+sponsorship.sponsor.url+'"><img src="'+sponsorship.sponsor.image_uri+'"></a></li>';
                            });
                            $('#sponsors-sidebar').html(sponsorsHtml);
                        });

                    });
                });
            });
            
            function render_template(event, template) {
                var starts_at = new Date(event.starts_at);
                var event_html = new String(template);
                event_html = event_html.replace(/{date}/, getDate(starts_at));
                event_html = event_html.replace(/{name}/, event.name);
                event_html = event_html.replace(/{location}/, event.location);
                event_html = event_html.replace(/{link}/, "event.html?id="+event.id);
                return event_html;
            }
        </script>
    </head>
    <body>
        <div id="wrap">
            <div class="shell">
                <div id="header">
                    <a href="/index.html"><img id="logo-img"src=""></a>
                </div>
                <div id="nav">
                    <ul class="left">
                        <li class="left"><a href="/index.html" class="">Home</a></li>
                        <li class="left"><a href="/schedule.html" class="">Schedule</a></li>
                        <li class="left reg"><a href="http://campsite.org/account/register">Register</a></li>
                        <li class="left reg"><a href="http://campsite.org/login">Sign in</a></li>
                    </ul>
                    <ul class="right">&nbsp;</ul>
                    <div class="cl">&nbsp;</div>
                </div>     
                <div id="main">
                    <div class="content left">
                        <div class="section recent-events">
                    <h1>Upcoming Events</h1>
                    <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Event</th>
                            <th>Location</th>
                        </tr>
                    </thead>
                    <tbody id="upcoming"><!-- js fill in here --></tbody>
                </table>
                </div>
                        <div style="margin-top: 40px"></div>
                        <div class="section recent-events">
                            <h1>Recent Events</h1>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Event</th>
                                        <th>Location</th>
                                    </tr>
                                </thead>
                                <tbody id="recent"><!-- js fill in here --></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="sidebar right">
                        <div class="section">
                            <h5>Top Sponsors</h5>
                            <ul id="sponsors-sidebar"></ul>
                        </div>
                    </div>
                    <div class="cl"></div>
                    <div id="footer">
                        <div class="foot-nav left">
                        Â© 2012-2014 <span class="group-title"></span>.  All rights reserved.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
