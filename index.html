<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
        <title></title>
        <link rel="shortcut icon" href="http://cloudcamp.org/bundles/cloudcamp/css/images/favicon.ico" />
        <link type="text/css" rel="stylesheet" href="css/cloudcamp.css" />
                
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <script type="text/javascript" src="js/utility.js"></script>
        <script type="text/javascript" src="js/config.js"></script>
        <script type="text/javascript" src="js/underscore-min.js"></script>

        <script id="addJS">

            var getGroupInfo = function () {
                return UTIL.campsite('groups/'+CONFIG.community, { 'fields': "name,description,groupAvatar.filename" });
            };

            var renderGroupInfo = function(group_info) {
                document.title = group_info.name;
                $('.group-title').html(group_info.name);
                $("#desc").html(group_info.description);
                if(_.has(group_info,"groupAvatar") && _.has(group_info.groupAvatar,"uri")) {
                    $("#logo-img").attr("src", group_info.groupAvatar.uri);
                }
            };

            var getEvents = function () {
                return UTIL.campsite('groups/'+CONFIG.community+'/events');
            };

            var renderEvents = function (events) {
                var now = new Date();
                var template = "<tr class=\"eventListGroup_online\"><td>{date}</td><td><a href=\"{link}\">{name}</a></td><td>{location}</td></tr>";

                var selector = $("#upcoming");
                _.each(events, function (event) {

                    var starts_at = new Date(event.starts_at);
                    var ends_at = new Date(event.ends_at);
                    if(ends_at.getTime() < now.getTime()) {
                        return;
                    }

                    var evt_temp = template.replace(/{date}/, UTIL.getDate(starts_at));
                        evt_temp = evt_temp.replace(/{name}/, event.name);
                        evt_temp = evt_temp.replace(/{location}/, event.location);
                        evt_temp = evt_temp.replace(/{link}/, "event.html?id="+event.id);
                    selector.prepend(evt_temp);
                });
            };

            var getSponsorships = function (events) {
                var event_ids = '';
                var first_iteration = true;
                _.each(events, function (event) {
                    event_ids = event.id + (first_iteration ? '' : ',') + event_ids;
                    first_iteration = false;
                });
                return UTIL.campsite('sponsorships', { 'event_id': event_ids, 'fields': 'level,sponsor', 'status': 'sponsoring' });
            };

            var renderSponsorships = function(data) {
                var sponsorsHtml = '';
                _.each(data, function(sponsorship) {
                    sponsorsHtml += '<li><a href="'+sponsorship.sponsor.url+'"><img src="'+sponsorship.sponsor.image_uri+'"></a></li>';
                });
                $('#sponsors-sidebar').html(sponsorsHtml);
            };


            var dom_dfd = $(document).ready().promise(); // resolved on page load

            // Retrieve group details then wait for page to load (if necessary) and render the group data
            getGroupInfo()
            .then(dom_dfd)
            .then(renderGroupInfo);


            //Retrieve event details, remember the deferred instance
            var events_dfd = getEvents();

            // Once event data is returned wait for the page to load (if necessary) then render the event data
            events_dfd
            .then( dom_dfd )
            .then( renderEvents );

            // Once event data is returned use that data to construct sponsorship request
            // after sponsorship data is returned wait for page to load (if necessary) then render the sponsors
            events_dfd
            .then( getSponsorships )
            .then( dom_dfd )
            .then( renderSponsorships );

        </script>
    </head>
    <body>
        <div id="wrap">
            <div class="shell">
                <div id="header">
                    <a href="index.html"><img id="logo-img"src=""></a>
                </div>

                <div id="nav">
                    <ul class="left">
                        <li class="left"><a href="index.html" class="">Home</a></li>
                        <li class="left"><a href="schedule.html" class="">Schedule</a></li>
                        <li class="left reg"><a href="http://campsite.org/account/register">Register</a></li>
                        <li class="left reg"><a href="http://campsite.org/login">Sign in</a></li>
                    </ul>
                    <ul class="right">&nbsp;</ul>
                    <div class="cl">&nbsp;</div>
                </div>   
                <div id="main">
                    <div class="content left">
                        <h1>Welcome to <span class="group-title"></span></h1>
                        <p id="desc"></p>

                        <p style="margin-bottom: 5px; margin-top: 15px">The events listed below have a confirmed time and place. Let us know if you'd like to put on a <span class="group-title"></span> in your city or region:</p>

                        <div class="section recent-events">        
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Event</th>
                                        <th>Location</th>
                                    </tr>
                                </thead>
                                <tbody id="upcoming"><!-- js fill in here --></tbody>
                            </table>
                            <div class="cl">&nbsp;</div>
                        </div>
                    </div>
                    <div class="sidebar right">
                        <div class="section">
                            <h5>Top Sponsors</h5>
                            <ul id="sponsors-sidebar"></ul>
                        </div>
                    </div>
                    <div class="cl"></div>
                    <div id="footer">
                        <div class="foot-nav left">
                        Â© 2012-2014 <span class="group-title"></span>.  All rights reserved.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
